<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Arcana</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300;1,400&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
<style>
/* â”€â”€ RESET â”€â”€ */
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}

/* â”€â”€ TOKENS â”€â”€ */
:root{
  --bg:#f9f8f6;
  --surface:#ffffff;
  --surface2:#f3f2ef;
  --border:#e4e2dc;
  --border2:#ccc9c0;
  --text:#1a1916;
  --muted:#7a7770;
  --accent:#2c2c2c;
  --accent2:#5a5a5a;
  --tag-bg:#efefec;
  --tag-border:#dddbd4;
  --chip-active-bg:#1a1916;
  --chip-active-text:#f9f8f6;
  --danger:#c0392b;
  --danger-bg:#fdf2f1;
  --header-h:56px;
  --radius:10px;
  --radius-sm:6px;
}

/* â”€â”€ BASE â”€â”€ */
html,body{height:100%;background:var(--bg);overflow:hidden;}
body{font-family:'DM Sans',sans-serif;font-size:15px;color:var(--text);line-height:1.5;}

/* â”€â”€ SCREENS â”€â”€ */
#root{position:relative;height:100vh;overflow:hidden;}

.screen{
  position:absolute;inset:0;
  display:flex;flex-direction:column;
  background:var(--bg);
  transform:translateX(100%);
  transition:transform 0.32s cubic-bezier(0.4,0,0.2,1);
  overflow:hidden;
  will-change:transform;
}
.screen.active{transform:translateX(0);}
.screen.prev{transform:translateX(-30%);}

/* â”€â”€ WELCOME â”€â”€ */
#screenWelcome{
  background:#1a1916;
  justify-content:center;align-items:center;
  transform:translateX(0);
}

.w-inner{
  width:min(420px,92%);
}

.w-wordmark{
  font-family:'DM Serif Display',serif;
  font-size:42px;
  color:#f9f8f6;
  letter-spacing:-1px;
  margin-bottom:4px;
}

.w-sub{
  font-size:13px;
  color:#6b6960;
  letter-spacing:0.5px;
  margin-bottom:40px;
}

.w-label{
  font-size:11px;
  font-weight:500;
  letter-spacing:1px;
  text-transform:uppercase;
  color:#4a4940;
  margin-bottom:10px;
}

/* style cards on welcome */
.style-cards{display:flex;flex-direction:column;gap:8px;margin-bottom:32px;}

.style-card{
  background:#242420;
  border:1px solid #333330;
  border-radius:var(--radius);
  padding:14px 16px;
  cursor:pointer;
  display:flex;align-items:center;gap:14px;
  transition:all 0.18s;
  text-align:left;
}
.style-card:hover{border-color:#555550;}
.style-card.sel{border-color:#f9f8f6;background:#2e2e2a;}

.style-card-icon{font-size:20px;width:28px;text-align:center;flex-shrink:0;}
.style-card-body{flex:1;}
.style-card-name{font-size:13px;font-weight:500;color:#f9f8f6;margin-bottom:2px;}
.style-card-desc{font-size:12px;color:#6b6960;}
.style-card-check{
  width:18px;height:18px;border-radius:50%;
  border:1.5px solid #444;
  display:flex;align-items:center;justify-content:center;
  font-size:10px;color:#f9f8f6;flex-shrink:0;
  transition:all 0.18s;
}
.style-card.sel .style-card-check{background:#f9f8f6;border-color:#f9f8f6;color:#1a1916;}

.api-section{margin-bottom:24px;}
.api-input-row{display:flex;gap:8px;}

/* â”€â”€ HEADER â”€â”€ */
.hdr{
  height:var(--header-h);
  background:var(--surface);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;
  padding:0 16px;
  gap:12px;
  flex-shrink:0;
  position:relative;
}

.hdr-back{
  background:none;border:none;
  color:var(--muted);cursor:pointer;
  width:36px;height:36px;
  display:flex;align-items:center;justify-content:center;
  border-radius:50%;
  font-size:20px;
  transition:background 0.15s;
  flex-shrink:0;
}
.hdr-back:hover{background:var(--surface2);}

.hdr-title{
  font-family:'DM Serif Display',serif;
  font-size:18px;
  color:var(--text);
  flex:1;
  letter-spacing:-0.3px;
}

.hdr-step{
  font-size:11px;
  font-weight:500;
  color:var(--muted);
  background:var(--surface2);
  border:1px solid var(--border);
  padding:3px 10px;
  border-radius:20px;
}

/* â”€â”€ BODY â”€â”€ */
.body{flex:1;overflow-y:auto;padding:20px 16px 40px;-webkit-overflow-scrolling:touch;}

/* â”€â”€ SECTION LABEL â”€â”€ */
.s-label{
  font-size:11px;font-weight:600;
  letter-spacing:0.8px;text-transform:uppercase;
  color:var(--muted);
  margin-bottom:10px;margin-top:24px;
}
.s-label:first-child{margin-top:0;}

/* â”€â”€ BLOCK â”€â”€ */
.block{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:16px;
  margin-bottom:12px;
}

/* â”€â”€ MODE TABS â”€â”€ */
.mode-tabs{
  display:grid;grid-template-columns:1fr 1fr;
  border:1px solid var(--border);
  border-radius:var(--radius);
  overflow:hidden;margin-bottom:16px;
  background:var(--surface2);
}
.m-tab{
  background:none;border:none;
  padding:11px 8px;
  font-family:'DM Sans',sans-serif;
  font-size:12px;font-weight:500;
  color:var(--muted);cursor:pointer;
  transition:all 0.18s;
  letter-spacing:0.3px;
}
.m-tab.active{
  background:var(--surface);
  color:var(--text);
  box-shadow:0 1px 4px rgba(0,0,0,0.08);
  border-radius:calc(var(--radius) - 1px);
}

/* â”€â”€ CHIPS â”€â”€ */
.chip-section{margin-bottom:20px;}

.chip-row{display:flex;flex-wrap:wrap;gap:7px;margin-top:8px;}

.chip{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:20px;
  padding:7px 13px;
  font-family:'DM Sans',sans-serif;
  font-size:13px;
  color:var(--text);
  cursor:pointer;
  transition:all 0.15s;
  white-space:nowrap;
  user-select:none;
}
.chip:hover{border-color:var(--border2);background:var(--surface2);}
.chip.on{
  background:var(--chip-active-bg);
  border-color:var(--chip-active-bg);
  color:var(--chip-active-text);
}

/* â”€â”€ INPUTS â”€â”€ */
input[type=text],input[type=password],textarea,select{
  width:100%;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-sm);
  color:var(--text);
  font-family:'DM Sans',sans-serif;
  font-size:14px;
  padding:10px 12px;
  outline:none;
  transition:border-color 0.15s;
  appearance:none;
}
input:focus,textarea:focus,select:focus{border-color:var(--accent2);}
textarea{resize:vertical;line-height:1.6;}
select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%237a7770' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px;}
select option{background:#fff;}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:7px;
  font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;
  padding:10px 18px;border-radius:var(--radius-sm);border:none;
  cursor:pointer;transition:all 0.15s;white-space:nowrap;
}
.btn-primary{background:var(--text);color:var(--bg);}
.btn-primary:hover{background:#333;}
.btn-primary:active{transform:scale(0.98);}
.btn-ghost{background:none;border:1px solid var(--border);color:var(--muted);}
.btn-ghost:hover{border-color:var(--border2);color:var(--text);}
.btn-danger{background:var(--danger-bg);border:1px solid #e8b4b0;color:var(--danger);}
.btn-full{width:100%;padding:13px;}
.btn-lg{font-size:14px;font-weight:500;padding:14px;}
.btn:disabled{opacity:0.4;cursor:not-allowed;transform:none!important;}
.btn-sm{padding:7px 13px;font-size:12px;}

.cta-wrap{padding-top:8px;padding-bottom:20px;}

/* â”€â”€ SPREAD CARDS â”€â”€ */
.spread-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;}
.sp-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:12px 14px;cursor:pointer;
  transition:all 0.15s;position:relative;
}
.sp-card:hover{border-color:var(--border2);}
.sp-card.on{border-color:var(--text);background:var(--surface2);}
.sp-card.on::after{content:'âœ“';position:absolute;top:8px;right:10px;font-size:12px;font-weight:600;color:var(--text);}
.sp-name{font-weight:600;font-size:13px;margin-bottom:3px;}
.sp-count{font-size:11px;color:var(--muted);margin-bottom:5px;}
.sp-desc{font-size:12px;color:var(--muted);line-height:1.4;}

.spread-cat{font-size:11px;font-weight:600;letter-spacing:0.8px;text-transform:uppercase;color:var(--muted);margin:16px 0 8px;}

/* â”€â”€ PHOTO â”€â”€ */
.photo-zone{
  border:1.5px dashed var(--border2);
  border-radius:var(--radius);
  padding:16px;text-align:center;
  background:var(--surface2);margin-bottom:12px;
}
#photoPreview{width:100%;max-height:240px;object-fit:contain;border-radius:var(--radius-sm);display:none;margin-bottom:10px;}
.photo-hint{font-size:13px;color:var(--muted);padding:8px 0;}
.photo-btns{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}

/* â”€â”€ DETECTED CARDS â”€â”€ */
.det-row{
  display:flex;align-items:center;gap:8px;
  padding:10px 12px;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-sm);
  margin-bottom:7px;
}
.det-name{flex:1;font-size:14px;}
.rev-btn{
  background:none;
  border:1px solid var(--border);
  border-radius:20px;
  padding:4px 10px;
  font-size:11px;font-weight:500;
  color:var(--muted);cursor:pointer;
  transition:all 0.15s;
  white-space:nowrap;
}
.rev-btn.on{border-color:#c0392b;color:#c0392b;background:#fdf2f1;}
.del-btn{background:none;border:none;color:var(--border2);cursor:pointer;font-size:18px;line-height:1;padding:0 2px;transition:color 0.15s;}
.del-btn:hover{color:var(--danger);}

/* â”€â”€ POSITION ROWS â”€â”€ */
.pos-row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;margin-bottom:8px;}
.pos-label-text{font-size:12px;color:var(--muted);margin-bottom:4px;}

/* â”€â”€ AUTOCOMPLETE â”€â”€ */
.ac-wrap{position:relative;}
.ac-list{
  position:absolute;top:100%;left:0;right:0;
  background:var(--surface);
  border:1px solid var(--border2);
  border-top:none;
  border-radius:0 0 var(--radius-sm) var(--radius-sm);
  max-height:160px;overflow-y:auto;z-index:200;
  display:none;
  box-shadow:0 4px 16px rgba(0,0,0,0.1);
}
.ac-list.open{display:block;}
.ac-item{padding:9px 12px;cursor:pointer;font-size:14px;transition:background 0.1s;}
.ac-item:hover,.ac-item.sel{background:var(--surface2);}

/* â”€â”€ READING OUTPUT â”€â”€ */
.reading-wrap{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:20px;
  font-family:'DM Serif Display',serif;
  font-size:17px;line-height:1.85;
  color:var(--text);
  white-space:pre-wrap;
}
.reading-meta{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px;}
.r-tag{
  font-size:11px;font-weight:600;letter-spacing:0.5px;
  background:var(--tag-bg);border:1px solid var(--tag-border);
  color:var(--muted);padding:4px 10px;border-radius:20px;
}

/* â”€â”€ DIVIDER â”€â”€ */
.divider{height:1px;background:var(--border);margin:20px 0;}

/* â”€â”€ NOTE BOX â”€â”€ */
.note{
  background:var(--surface2);
  border-left:3px solid var(--border2);
  padding:10px 14px;
  font-size:13px;color:var(--muted);
  line-height:1.6;margin-bottom:14px;
  border-radius:0 var(--radius-sm) var(--radius-sm) 0;
}

/* â”€â”€ TOAST â”€â”€ */
#toast{
  position:fixed;bottom:24px;left:50%;
  transform:translateX(-50%) translateY(60px);
  background:var(--text);color:var(--bg);
  font-size:13px;font-weight:500;
  padding:10px 20px;border-radius:var(--radius);
  z-index:999;transition:transform 0.25s;white-space:nowrap;
  box-shadow:0 4px 16px rgba(0,0,0,0.2);
}
#toast.show{transform:translateX(-50%) translateY(0);}

/* â”€â”€ SPINNER â”€â”€ */
.spin{display:inline-block;width:14px;height:14px;border:2px solid rgba(0,0,0,0.15);border-top-color:currentColor;border-radius:50%;animation:_s 0.65s linear infinite;vertical-align:middle;}
@keyframes _s{to{transform:rotate(360deg);}}

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

@media(max-width:400px){
  .spread-grid{grid-template-columns:1fr;}
  .w-wordmark{font-size:34px;}
}
</style>
</head>
<body>
<div id="root">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 0 â€” WELCOME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen active" id="screenWelcome">
  <div class="body" style="display:flex;align-items:center;justify-content:center;min-height:100%;">
    <div class="w-inner">

      <div class="w-wordmark">Arcana</div>
      <div class="w-sub">Assistente per la lettura dei tarocchi</div>

      <!-- STILE -->
      <div class="w-label">Stile di lettura</div>
      <div class="style-cards">
        <button class="style-card sel" id="sc-psico" onclick="selStyle('psicologica')">
          <span class="style-card-icon">ğŸŒ¿</span>
          <div class="style-card-body">
            <div class="style-card-name">Psicologica & Introspettiva</div>
            <div class="style-card-desc">Crescita personale, emozioni, pattern interiori</div>
          </div>
          <div class="style-card-check" id="chk-psico">âœ“</div>
        </button>
        <button class="style-card" id="sc-carta" onclick="selStyle('cartomantica')">
          <span class="style-card-icon">ğŸ”®</span>
          <div class="style-card-body">
            <div class="style-card-name">Cartomantica & Divinatoria</div>
            <div class="style-card-desc">Mistica, profetica, energie e futuro</div>
          </div>
          <div class="style-card-check" id="chk-carta">âœ“</div>
        </button>
      </div>

      <!-- API KEY -->
      <div class="api-section">
        <div class="w-label">Google Gemini API Key <span style="color:#4a4940;font-weight:400;text-transform:none;font-size:11px;">(gratis su aistudio.google.com)</span></div>
        <div class="api-input-row">
          <input type="password" id="apiKeyInput" placeholder="AIza..." style="background:#242420;border-color:#333330;color:#f9f8f6;flex:1;" />
          <button class="btn btn-ghost" onclick="saveApiKey()" style="border-color:#333330;color:#9a9890;">Salva</button>
        </div>
        <div id="apiStatus" style="font-size:12px;color:#4a4940;margin-top:6px;min-height:16px;"></div>
      </div>

      <button class="btn btn-primary btn-full btn-lg" onclick="goToSession()" style="background:#f9f8f6;color:#1a1916;">
        Inizia sessione â†’
      </button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 1 â€” PROFILO CLIENTE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screenRecord">
  <div class="hdr">
    <button class="hdr-back" onclick="goBack('screenWelcome')">â†</button>
    <div class="hdr-title">Profilo cliente</div>
    <span class="hdr-step">1 / 4</span>
  </div>
  <div class="body">

    <!-- MODE SWITCH -->
    <div class="mode-tabs">
      <button class="m-tab active" id="modeTabT" onclick="switchMode('transcript')">ğŸ“‹ Incolla trascrizione</button>
      <button class="m-tab" id="modeTabQ" onclick="switchMode('quick')">âš¡ Selezione rapida</button>
    </div>

    <!-- â”€â”€ TRASCRIZIONE â”€â”€ -->
    <div id="modeTranscript">
      <div class="block">
        <div style="font-size:13px;color:var(--muted);margin-bottom:10px;line-height:1.6;">
          Incolla la trascrizione completa della conversazione â€” saluti inclusi. L'AI estrae solo ciÃ² che serve.
        </div>
        <textarea id="transcriptPaste" rows="10" placeholder="Incolla qui la trascrizione...&#10;&#10;Es: Ciao, come stai? â€” Bene grazie, sono un po' ansiosa...&#10;Di cosa vorresti parlare? â€” Del lavoro, ho perso il mio posto..."></textarea>
        <div style="display:flex;justify-content:flex-end;margin-top:8px;">
          <button class="btn btn-ghost btn-sm" onclick="document.getElementById('transcriptPaste').value=''">Svuota</button>
        </div>
      </div>
    </div>

    <!-- â”€â”€ SELEZIONE RAPIDA â”€â”€ -->
    <div id="modeQuick" style="display:none;">

      <!-- IDENTITÃ€ -->
      <div class="chip-section">
        <div class="s-label">Genere</div>
        <div class="chip-row" id="g-genere">
          <button class="chip" onclick="tc(this,'genere')">Donna</button>
          <button class="chip" onclick="tc(this,'genere')">Uomo</button>
          <button class="chip" onclick="tc(this,'genere')">Non binario</button>
          <button class="chip" onclick="tc(this,'genere')">Preferisce non dirlo</button>
        </div>
      </div>

      <div class="chip-section">
        <div class="s-label">EtÃ </div>
        <div class="chip-row" id="g-eta">
          <button class="chip" onclick="tc(this,'eta')">Under 18</button>
          <button class="chip" onclick="tc(this,'eta')">18â€“25</button>
          <button class="chip" onclick="tc(this,'eta')">26â€“35</button>
          <button class="chip" onclick="tc(this,'eta')">36â€“45</button>
          <button class="chip" onclick="tc(this,'eta')">46â€“55</button>
          <button class="chip" onclick="tc(this,'eta')">56â€“65</button>
          <button class="chip" onclick="tc(this,'eta')">65+</button>
        </div>
      </div>

      <!-- RELAZIONE -->
      <div class="chip-section">
        <div class="s-label">Situazione sentimentale</div>
        <div class="chip-row" id="g-relazione">
          <button class="chip" onclick="tc(this,'relazione')">Single</button>
          <button class="chip" onclick="tc(this,'relazione')">Si sta frequentando</button>
          <button class="chip" onclick="tc(this,'relazione')">In coppia (non convivente)</button>
          <button class="chip" onclick="tc(this,'relazione')">Convivente</button>
          <button class="chip" onclick="tc(this,'relazione')">Fidanzato/a</button>
          <button class="chip" onclick="tc(this,'relazione')">Sposato/a</button>
          <button class="chip" onclick="tc(this,'relazione')">Matrimonio in crisi</button>
          <button class="chip" onclick="tc(this,'relazione')">Separato/a</button>
          <button class="chip" onclick="tc(this,'relazione')">Divorziato/a</button>
          <button class="chip" onclick="tc(this,'relazione')">Vedovo/a</button>
          <button class="chip" onclick="tc(this,'relazione')">Relazione a distanza</button>
          <button class="chip" onclick="tc(this,'relazione')">Coppia aperta</button>
          <button class="chip" onclick="tc(this,'relazione')">Ha un amante</button>
          <button class="chip" onclick="tc(this,'relazione')">Ãˆ l'amante</button>
          <button class="chip" onclick="tc(this,'relazione')">Vuole tornare con ex</button>
          <button class="chip" onclick="tc(this,'relazione')">Ha appena lasciato</button>
          <button class="chip" onclick="tc(this,'relazione')">Ãˆ stato lasciato/a</button>
          <button class="chip" onclick="tc(this,'relazione')">Non cerca relazione</button>
        </div>
      </div>

      <!-- FIGLI / FAMIGLIA -->
      <div class="chip-section">
        <div class="s-label">Figli / famiglia</div>
        <div class="chip-row" id="g-figli">
          <button class="chip" onclick="tc(this,'figli')">Senza figli (scelta)</button>
          <button class="chip" onclick="tc(this,'figli')">Senza figli (vorrebbe)</button>
          <button class="chip" onclick="tc(this,'figli')">Un figlio</button>
          <button class="chip" onclick="tc(this,'figli')">PiÃ¹ figli</button>
          <button class="chip" onclick="tc(this,'figli')">In attesa</button>
          <button class="chip" onclick="tc(this,'figli')">Sta cercando di avere figli</button>
          <button class="chip" onclick="tc(this,'figli')">Figlio/a con problemi</button>
          <button class="chip" onclick="tc(this,'figli')">Genitore single</button>
          <button class="chip" onclick="tc(this,'figli')">Famiglia allargata</button>
          <button class="chip" onclick="tc(this,'figli')">Conflitti familiari</button>
          <button class="chip" onclick="tc(this,'figli')">Lontano dalla famiglia</button>
        </div>
      </div>

      <!-- LAVORO -->
      <div class="chip-section">
        <div class="s-label">Situazione lavorativa</div>
        <div class="chip-row" id="g-lavoro">
          <button class="chip" onclick="tc(this,'lavoro')">Dipendente stabile</button>
          <button class="chip" onclick="tc(this,'lavoro')">Dipendente insoddisfatto</button>
          <button class="chip" onclick="tc(this,'lavoro')">Libero professionista</button>
          <button class="chip" onclick="tc(this,'lavoro')">Imprenditore/trice</button>
          <button class="chip" onclick="tc(this,'lavoro')">Disoccupato/a</button>
          <button class="chip" onclick="tc(this,'lavoro')">In cerca di lavoro</button>
          <button class="chip" onclick="tc(this,'lavoro')">Studente</button>
          <button class="chip" onclick="tc(this,'lavoro')">Studente + lavoro</button>
          <button class="chip" onclick="tc(this,'lavoro')">Cambiamento di carriera</button>
          <button class="chip" onclick="tc(this,'lavoro')">Ha appena cambiato lavoro</button>
          <button class="chip" onclick="tc(this,'lavoro')">Rischio licenziamento</button>
          <button class="chip" onclick="tc(this,'lavoro')">Vuole aprire attivitÃ </button>
          <button class="chip" onclick="tc(this,'lavoro')">Lavoro in crisi</button>
          <button class="chip" onclick="tc(this,'lavoro')">Conflitti con colleghi</button>
          <button class="chip" onclick="tc(this,'lavoro')">Conflitti col capo</button>
          <button class="chip" onclick="tc(this,'lavoro')">Pensionato/a</button>
          <button class="chip" onclick="tc(this,'lavoro')">Casalingo/a</button>
        </div>
      </div>

      <!-- SOLDI -->
      <div class="chip-section">
        <div class="s-label">Situazione economica</div>
        <div class="chip-row" id="g-soldi">
          <button class="chip" onclick="tc(this,'soldi')">Stabile</button>
          <button class="chip" onclick="tc(this,'soldi')">DifficoltÃ  economiche</button>
          <button class="chip" onclick="tc(this,'soldi')">Debiti</button>
          <button class="chip" onclick="tc(this,'soldi')">Dipendente economicamente</button>
          <button class="chip" onclick="tc(this,'soldi')">Vuole indipendenza economica</button>
          <button class="chip" onclick="tc(this,'soldi')">Investimento importante</button>
          <button class="chip" onclick="tc(this,'soldi')">EreditÃ  / questioni legali</button>
        </div>
      </div>

      <!-- SALUTE -->
      <div class="chip-section">
        <div class="s-label">Salute & benessere</div>
        <div class="chip-row" id="g-salute">
          <button class="chip" onclick="tc(this,'salute')">In salute</button>
          <button class="chip" onclick="tc(this,'salute')">Problema fisico cronico</button>
          <button class="chip" onclick="tc(this,'salute')">Problema fisico recente</button>
          <button class="chip" onclick="tc(this,'salute')">Ansia / attacchi di panico</button>
          <button class="chip" onclick="tc(this,'salute')">Depressione</button>
          <button class="chip" onclick="tc(this,'salute')">Burnout</button>
          <button class="chip" onclick="tc(this,'salute')">Disturbi del sonno</button>
          <button class="chip" onclick="tc(this,'salute')">In terapia</button>
          <button class="chip" onclick="tc(this,'salute')">Cerca supporto psicologico</button>
          <button class="chip" onclick="tc(this,'salute')">Percorso di guarigione</button>
        </div>
      </div>

      <!-- TEMA LETTURA -->
      <div class="chip-section">
        <div class="s-label">Tema principale della lettura <span style="color:#aaa;font-weight:400;">(puoi sceglierne piÃ¹ di uno)</span></div>
        <div class="chip-row" id="g-tema">
          <button class="chip" onclick="tcm(this,'tema')">â¤ï¸ Amore</button>
          <button class="chip" onclick="tcm(this,'tema')">ğŸ’” Fine relazione</button>
          <button class="chip" onclick="tcm(this,'tema')">ğŸ” Ex / ritorno</button>
          <button class="chip" onclick="tcm(this,'tema')">ğŸ’¼ Lavoro</button>
          <button class="chip" onclick="tcm(this,'tema')">ğŸ’° Soldi</button>
          <button class="chip" onclick="tcm(this,'tema')">ğŸŒ¿ Salute</button>
          <button class="chip" onclick="tcm(this,'tema')">ğŸ  Famiglia</button>
          <button class="chip" onclick="tcm(this,'tema')">âœ¨ Spirituale</button>
          <button class="chip" onclick="tcm(this,'tema')">ğŸ”„ Cambiamento</button>
          <button class="chip" onclick="tcm(this,'tema')">ğŸ¯ Decisione importante</button>
          <button class="chip" onclick="tcm(this,'tema')">ğŸšª Nuovi inizi</button>
          <button class="chip" onclick="tcm(this,'tema')">âš¡ Blocco / stallo</button>
          <button class="chip" onclick="tcm(this,'tema')">ğŸ”® Visione generale</button>
          <button class="chip" onclick="tcm(this,'tema')">ğŸ§˜ Crescita personale</button>
        </div>
      </div>

      <!-- STATO EMOTIVO -->
      <div class="chip-section">
        <div class="s-label">Stato emotivo oggi <span style="color:#aaa;font-weight:400;">(anche piÃ¹ di uno)</span></div>
        <div class="chip-row" id="g-emozione">
          <button class="chip" onclick="tcm(this,'emozione')">Ansioso/a</button>
          <button class="chip" onclick="tcm(this,'emozione')">Confuso/a</button>
          <button class="chip" onclick="tcm(this,'emozione')">Triste</button>
          <button class="chip" onclick="tcm(this,'emozione')">Arrabbiato/a</button>
          <button class="chip" onclick="tcm(this,'emozione')">Spaventato/a</button>
          <button class="chip" onclick="tcm(this,'emozione')">Speranzoso/a</button>
          <button class="chip" onclick="tcm(this,'emozione')">Bloccato/a</button>
          <button class="chip" onclick="tcm(this,'emozione')">Esausto/a</button>
          <button class="chip" onclick="tcm(this,'emozione')">In crisi</button>
          <button class="chip" onclick="tcm(this,'emozione')">Curioso/a</button>
          <button class="chip" onclick="tcm(this,'emozione')">Sereno/a</button>
          <button class="chip" onclick="tcm(this,'emozione')">Ambivalente</button>
          <button class="chip" onclick="tcm(this,'emozione')">Sollievo</button>
          <button class="chip" onclick="tcm(this,'emozione')">Eccitato/a</button>
          <button class="chip" onclick="tcm(this,'emozione')">Rassegnato/a</button>
          <button class="chip" onclick="tcm(this,'emozione')">Senso di colpa</button>
        </div>
      </div>

      <!-- NOTE LIBERE -->
      <div class="s-label">Note aggiuntive</div>
      <textarea id="quickNotes" rows="3" placeholder="Dettagli specifici emersi durante la conversazione... (es: ha perso il lavoro da 3 mesi, vuole capire se tornare con l'ex, sta per trasferirsi)"></textarea>

    </div><!-- fine modeQuick -->

    <div class="divider"></div>
    <div class="cta-wrap">
      <button class="btn btn-primary btn-full btn-lg" id="btnAnalyze" onclick="analyzeConversation()">
        Analizza e procedi â†’
      </button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 2 â€” PROFILO + STESA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screenSpread">
  <div class="hdr">
    <button class="hdr-back" onclick="goBack('screenRecord')">â†</button>
    <div class="hdr-title">Scegli la stesa</div>
    <span class="hdr-step">2 / 4</span>
  </div>
  <div class="body">

    <div class="s-label">Profilo del cliente</div>
    <div class="block" id="profileDisplay" style="font-size:14px;line-height:1.7;color:var(--text);">
      Analisi in corso...
    </div>

    <div class="s-label">Stese consigliate</div>
    <div class="spread-cat">Brevi â€” 3 / 5 carte</div>
    <div class="spread-grid" id="shortSpreads"></div>

    <div class="spread-cat">Lunghe â€” 7 / 10 carte</div>
    <div class="spread-grid" id="longSpreads"></div>

    <div class="divider"></div>
    <div class="cta-wrap">
      <button class="btn btn-primary btn-full btn-lg" id="btnGoCards" onclick="goToCards()" disabled>
        Procedi con le carte â†’
      </button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 3 â€” FOTO & CARTE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screenCards">
  <div class="hdr">
    <button class="hdr-back" onclick="goBack('screenSpread')">â†</button>
    <div class="hdr-title">Inserisci le carte</div>
    <span class="hdr-step">3 / 4</span>
  </div>
  <div class="body">

    <div class="note" id="spreadNameDisplay">â€”</div>

    <!-- FOTO -->
    <div class="s-label">Scansione foto</div>
    <div class="block">
      <div style="font-size:13px;color:var(--muted);margin-bottom:12px;">Fotografa le carte sul tavolo â€” l'AI le riconoscerÃ  automaticamente.</div>
      <div class="photo-zone">
        <img id="photoPreview" src="" alt="" />
        <div id="photoPlaceholder" class="photo-hint">Nessuna foto caricata</div>
      </div>
      <div class="photo-btns">
        <button class="btn btn-ghost" onclick="takePicture()">ğŸ“¸ Scatta</button>
        <button class="btn btn-ghost" onclick="uploadPicture()">ğŸ“ Carica</button>
        <button class="btn btn-primary" id="btnAnalyzePhoto" onclick="analyzePhoto()" disabled>Analizza foto</button>
      </div>
      <input type="file" id="fileInput" accept="image/*" capture="environment" onchange="handlePhotoFile(event)" style="display:none;">
      <input type="file" id="fileInputUpload" accept="image/*" onchange="handlePhotoFile(event)" style="display:none;">
    </div>

    <!-- CARTE RILEVATE -->
    <div class="s-label">Carte rilevate</div>
    <div class="block">
      <div id="detectedCards"></div>
      <div id="manualCardWrap" style="margin-top:10px;">
        <div class="ac-wrap">
          <input type="text" id="manualCardInput" placeholder="+ Aggiungi carta manualmente..." oninput="showACManual(this)" onblur="hideACManual()" onkeydown="navACManual(event)" autocomplete="off" />
          <div class="ac-list" id="acManual"></div>
        </div>
      </div>
    </div>

    <!-- POSIZIONI -->
    <div class="s-label">Assegna le posizioni</div>
    <div class="block">
      <div style="font-size:13px;color:var(--muted);margin-bottom:14px;">Associa ogni carta alla sua posizione nella stesa.</div>
      <div id="positionRows"></div>
    </div>

    <div class="divider"></div>
    <div class="cta-wrap">
      <button class="btn btn-primary btn-full btn-lg" id="btnGenerate" onclick="generateReading()">
        âœ¦ Genera la lettura
      </button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 4 â€” LETTURA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screenReading">
  <div class="hdr">
    <button class="hdr-back" onclick="goBack('screenCards')">â†</button>
    <div class="hdr-title">La tua lettura</div>
    <span class="hdr-step">4 / 4</span>
  </div>
  <div class="body">
    <div class="reading-meta" id="readingMeta"></div>
    <div class="reading-wrap" id="readingOutput">
      <span class="spin"></span> Generazione in corso...
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:14px;">
      <button class="btn btn-ghost" onclick="copyReading()">ğŸ“‹ Copia</button>
      <button class="btn btn-ghost" onclick="printReading()">ğŸ–¨ Stampa</button>
      <button class="btn btn-primary" onclick="newSession()">Nuova sessione</button>
    </div>
  </div>
</div>

</div><!-- #root -->
<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let apiKey = localStorage.getItem('arcana_gkey') || '';
let readingStyle = 'psicologica';
let currentScreen = 'screenWelcome';
let currentMode = 'transcript';
let chipSel = {};            // single-select groups
let chipSelMulti = {};       // multi-select groups
let clientProfile = '';
let suggestedSpreads = null;
let chosenSpread = null;
let detectedCardsList = [];
let photoBase64 = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onload = () => {
  if(apiKey){
    document.getElementById('apiKeyInput').value = 'â€¢'.repeat(20);
    document.getElementById('apiStatus').textContent = 'âœ“ Chiave configurata';
  }
  selStyle('psicologica');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API KEY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveApiKey(){
  const v = document.getElementById('apiKeyInput').value.trim();
  if(!v || v.includes('â€¢')){ toast('Inserisci una chiave valida'); return; }
  apiKey = v;
  localStorage.setItem('arcana_gkey', apiKey);
  document.getElementById('apiKeyInput').value = 'â€¢'.repeat(20);
  document.getElementById('apiStatus').textContent = 'âœ“ Chiave salvata';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GEMINI API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function callGemini(prompt, systemNote='', maxTokens=2500){
  if(!apiKey) throw new Error('API key mancante â€” salvala nella schermata iniziale');
  const model = 'gemini-1.5-flash';
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
  const body = {
    contents:[{role:'user', parts:[{text: systemNote ? systemNote+'\n\n'+prompt : prompt}]}],
    generationConfig:{maxOutputTokens: maxTokens, temperature:0.85}
  };
  const res = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  if(!res.ok){const e=await res.json();throw new Error(e.error?.message||'Errore API Gemini');}
  const d = await res.json();
  return d.candidates?.[0]?.content?.parts?.[0]?.text || '';
}

async function callGeminiWithImage(base64img, prompt){
  if(!apiKey) throw new Error('API key mancante');
  const model = 'gemini-1.5-flash';
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
  const body = {
    contents:[{role:'user', parts:[
      {inline_data:{mime_type:'image/jpeg', data:base64img}},
      {text: prompt}
    ]}],
    generationConfig:{maxOutputTokens:800, temperature:0.2}
  };
  const res = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  if(!res.ok){const e=await res.json();throw new Error(e.error?.message||'Errore API Gemini');}
  const d = await res.json();
  return d.candidates?.[0]?.content?.parts?.[0]?.text || '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id){
  document.getElementById(currentScreen).classList.remove('active');
  document.getElementById(currentScreen).classList.add('prev');
  setTimeout(()=>document.getElementById(currentScreen).classList.remove('prev'),350);
  document.getElementById(id).classList.add('active');
  currentScreen = id;
}

function goBack(id){
  const cur = document.getElementById(currentScreen);
  cur.style.transition='transform 0.3s cubic-bezier(0.4,0,0.2,1)';
  cur.style.transform='translateX(100%)';
  setTimeout(()=>{cur.classList.remove('active');cur.style.transform='';cur.style.transition='';},300);
  document.getElementById(id).classList.add('active');
  document.getElementById(id).classList.remove('prev');
  currentScreen = id;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WELCOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selStyle(s){
  readingStyle = s;
  document.getElementById('sc-psico').classList.toggle('sel', s==='psicologica');
  document.getElementById('sc-carta').classList.toggle('sel', s==='cartomantica');
  document.getElementById('chk-psico').style.background = s==='psicologica'?'#f9f8f6':'transparent';
  document.getElementById('chk-psico').style.color = s==='psicologica'?'#1a1916':'transparent';
  document.getElementById('chk-carta').style.background = s==='cartomantica'?'#f9f8f6':'transparent';
  document.getElementById('chk-carta').style.color = s==='cartomantica'?'#1a1916':'transparent';
}

function goToSession(){
  if(!apiKey){ toast('Salva prima la tua API key'); return; }
  showScreen('screenRecord');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODE + CHIPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchMode(m){
  currentMode = m;
  document.getElementById('modeTabT').classList.toggle('active', m==='transcript');
  document.getElementById('modeTabQ').classList.toggle('active', m==='quick');
  document.getElementById('modeTranscript').style.display = m==='transcript'?'block':'none';
  document.getElementById('modeQuick').style.display = m==='quick'?'block':'none';
}

// single-select
function tc(btn, group){
  btn.closest('.chip-row').querySelectorAll('.chip').forEach(c=>c.classList.remove('on'));
  btn.classList.add('on');
  chipSel[group] = btn.textContent.replace(/^[^\w]+/,'').trim();
}

// multi-select
function tcm(btn, group){
  btn.classList.toggle('on');
  if(!chipSelMulti[group]) chipSelMulti[group]=[];
  const vals = Array.from(btn.closest('.chip-row').querySelectorAll('.chip.on')).map(c=>c.textContent.replace(/^[^\w]+/,'').trim());
  chipSelMulti[group] = vals;
}

function buildQuickProfile(){
  const parts=[];
  const s=chipSel, m=chipSelMulti;
  if(s.genere)    parts.push(s.genere);
  if(s.eta)       parts.push(`${s.eta} anni`);
  if(s.relazione) parts.push(`Situazione sentimentale: ${s.relazione}`);
  if(s.figli)     parts.push(`Famiglia: ${s.figli}`);
  if(s.lavoro)    parts.push(`Lavoro: ${s.lavoro}`);
  if(s.soldi)     parts.push(`Situazione economica: ${s.soldi}`);
  if(s.salute)    parts.push(`Salute: ${s.salute}`);
  if(m.tema?.length)    parts.push(`Tema lettura: ${m.tema.join(', ')}`);
  if(m.emozione?.length)parts.push(`Stato emotivo: ${m.emozione.join(', ')}`);
  const note = document.getElementById('quickNotes').value.trim();
  if(note) parts.push(note);
  return parts.join('. ');
}

function resetQuick(){
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('on'));
  chipSel={}; chipSelMulti={};
  document.getElementById('quickNotes').value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANALYZE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function analyzeConversation(){
  let input = '';
  if(currentMode==='transcript'){
    input = document.getElementById('transcriptPaste').value.trim();
    if(!input){ toast('Incolla prima la trascrizione'); return; }
  } else {
    input = buildQuickProfile();
    if(input.length < 10){ toast('Seleziona almeno alcune opzioni'); return; }
  }

  const btn = document.getElementById('btnAnalyze');
  btn.disabled=true; btn.innerHTML='<span class="spin"></span> Analisi...';

  const inputDesc = currentMode==='transcript'
    ? `TRASCRIZIONE CONVERSAZIONE (estrai solo le informazioni utili, ignora saluti e parti irrilevanti):\n${input}`
    : `PROFILO RAPIDO:\n${input}`;

  const prompt = `${inputDesc}

Basandoti su questo, rispondi SOLO in JSON valido (nessun testo fuori dal JSON, nessun markdown):
{
  "profilo": "riassunto strutturato del cliente in 4-6 righe",
  "stese_brevi": [
    {"nome":"...", "carte":3, "posizioni":["Pos1","Pos2","Pos3"], "descrizione":"perchÃ© Ã¨ adatta"},
    {"nome":"...", "carte":4, "posizioni":["Pos1","Pos2","Pos3","Pos4"], "descrizione":"..."},
    {"nome":"...", "carte":5, "posizioni":["Pos1","Pos2","Pos3","Pos4","Pos5"], "descrizione":"..."}
  ],
  "stese_lunghe": [
    {"nome":"...", "carte":7, "posizioni":["Pos1","Pos2","Pos3","Pos4","Pos5","Pos6","Pos7"], "descrizione":"..."},
    {"nome":"...", "carte":8, "posizioni":["Pos1","Pos2","Pos3","Pos4","Pos5","Pos6","Pos7","Pos8"], "descrizione":"..."},
    {"nome":"...", "carte":10, "posizioni":["Pos1","Pos2","Pos3","Pos4","Pos5","Pos6","Pos7","Pos8","Pos9","Pos10"], "descrizione":"..."}
  ]
}`;

  try{
    const raw = await callGemini(prompt, 'Sei un esperto di tarocchi. Rispondi SOLO in JSON valido, senza markdown, senza backtick, senza testo aggiuntivo.', 1500);
    const cleaned = raw.replace(/```json|```/g,'').trim();
    const data = JSON.parse(cleaned);
    clientProfile = data.profilo;
    suggestedSpreads = {brevi: data.stese_brevi, lunghe: data.stese_lunghe};
    document.getElementById('profileDisplay').textContent = clientProfile;
    renderSpreadSuggestions();
    showScreen('screenSpread');
  }catch(e){
    toast('Errore: '+e.message);
  }

  btn.disabled=false; btn.textContent='Analizza e procedi â†’';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPREADS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSpreadSuggestions(){
  chosenSpread=null;
  document.getElementById('btnGoCards').disabled=true;

  function renderGrid(id, list){
    const cont=document.getElementById(id); cont.innerHTML='';
    list.forEach((s,i)=>{
      const d=document.createElement('div');
      d.className='sp-card';
      d.innerHTML=`<div class="sp-name">${s.nome}</div><div class="sp-count">${s.carte} carte</div><div class="sp-desc">${s.descrizione}</div>`;
      d.onclick=()=>chooseSpread(s,id,i);
      cont.appendChild(d);
    });
  }
  renderGrid('shortSpreads', suggestedSpreads.brevi);
  renderGrid('longSpreads', suggestedSpreads.lunghe);
}

function chooseSpread(s, gridId, idx){
  document.querySelectorAll('.sp-card').forEach(c=>c.classList.remove('on'));
  document.getElementById(gridId).children[idx].classList.add('on');
  chosenSpread=s;
  document.getElementById('btnGoCards').disabled=false;
}

function goToCards(){
  if(!chosenSpread){ toast('Scegli una stesa'); return; }
  document.getElementById('spreadNameDisplay').textContent=`${chosenSpread.nome} â€” ${chosenSpread.carte} carte`;
  renderPositionRows();
  showScreen('screenCards');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHOTO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function takePicture(){ document.getElementById('fileInput').click(); }
function uploadPicture(){ document.getElementById('fileInputUpload').click(); }

function handlePhotoFile(e){
  const file=e.target.files[0]; if(!file)return;
  const r=new FileReader();
  r.onload=ev=>{
    photoBase64=ev.target.result.split(',')[1];
    document.getElementById('photoPreview').src=ev.target.result;
    document.getElementById('photoPreview').style.display='block';
    document.getElementById('photoPlaceholder').style.display='none';
    document.getElementById('btnAnalyzePhoto').disabled=false;
  };
  r.readAsDataURL(file);
  e.target.value='';
}

async function analyzePhoto(){
  if(!photoBase64){toast('Carica prima una foto');return;}
  const btn=document.getElementById('btnAnalyzePhoto');
  btn.disabled=true; btn.innerHTML='<span class="spin"></span>';
  try{
    const prompt=`Analizza questa foto di carte dei tarocchi. Identifica TUTTE le carte visibili.
Usa la nomenclatura italiana standard: Arcani Maggiori (es. "Il Mago", "La Luna"), Arcani Minori (es. "3 di Coppe", "Re di Bastoni").
Per ogni carta indica se Ã¨ dritta o rovesciata (capovolta).
Rispondi SOLO in JSON:
{"carte":[{"nome":"Il Mago","rovesciata":false},{"nome":"3 di Coppe","rovesciata":true}],"note":"eventuali note"}`;
    const raw=await callGeminiWithImage(photoBase64,prompt);
    const cleaned=raw.replace(/```json|```/g,'').trim();
    const data=JSON.parse(cleaned);
    detectedCardsList=data.carte.map(c=>({name:c.nome,reversed:c.rovesciata||false}));
    renderDetectedCards();
    if(data.note) toast(data.note);
  }catch(e){ toast('Rilevamento non riuscito: '+e.message+' â€” inserisci le carte manualmente'); }
  btn.disabled=false; btn.textContent='Analizza foto';
}

function renderDetectedCards(){
  const cont=document.getElementById('detectedCards'); cont.innerHTML='';
  detectedCardsList.forEach((c,i)=>{
    const row=document.createElement('div');
    row.className='det-row';
    row.innerHTML=`<div class="det-name">${c.name}</div>
      <button class="rev-btn ${c.reversed?'on':''}" id="rb-${i}" onclick="toggleDetRev(${i})">${c.reversed?'Rovesc.':'Dritta'}</button>
      <button class="del-btn" onclick="removeDetCard(${i})">Ã—</button>`;
    cont.appendChild(row);
  });
  syncPositionDropdowns();
}

function toggleDetRev(i){ detectedCardsList[i].reversed=!detectedCardsList[i].reversed; renderDetectedCards(); }
function removeDetCard(i){ detectedCardsList.splice(i,1); renderDetectedCards(); }

function showACManual(input){
  const val=input.value.toLowerCase().trim();
  const list=document.getElementById('acManual');
  if(!val){list.classList.remove('open');return;}
  const matches=ALL_CARDS.filter(c=>c.toLowerCase().includes(val)).slice(0,8);
  if(!matches.length){list.classList.remove('open');return;}
  list.innerHTML=matches.map(c=>`<div class="ac-item" onmousedown="selectManualCard('${c}')">${c}</div>`).join('');
  list.classList.add('open');
}
function hideACManual(){ setTimeout(()=>document.getElementById('acManual').classList.remove('open'),150); }
function selectManualCard(card){
  detectedCardsList.push({name:card,reversed:false});
  document.getElementById('manualCardInput').value='';
  document.getElementById('acManual').classList.remove('open');
  renderDetectedCards();
}
function navACManual(e){
  const list=document.getElementById('acManual');
  const items=list.querySelectorAll('.ac-item');
  let sel=list.querySelector('.sel');
  if(e.key==='ArrowDown'){e.preventDefault();if(!sel)items[0]?.classList.add('sel');else{sel.classList.remove('sel');(sel.nextElementSibling||items[0]).classList.add('sel');}}
  else if(e.key==='ArrowUp'){e.preventDefault();if(sel){sel.classList.remove('sel');(sel.previousElementSibling||items[items.length-1]).classList.add('sel');}}
  else if(e.key==='Enter'&&sel){e.preventDefault();selectManualCard(sel.textContent);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POSITION ROWS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPositionRows(){
  if(!chosenSpread)return;
  const cont=document.getElementById('positionRows'); cont.innerHTML='';
  chosenSpread.posizioni.forEach((pos,i)=>{
    const wrap=document.createElement('div');
    wrap.style.marginBottom='14px';
    wrap.innerHTML=`<div class="pos-label-text">${pos}</div>
      <div style="display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;">
        <div class="ac-wrap">
          <input type="text" class="pos-card-input" data-pos="${i}" placeholder="Cerca carta..." oninput="showACPos(this,${i})" onblur="hideACPos(${i})" onkeydown="navACPos(event,${i})" autocomplete="off"/>
          <div class="ac-list" id="acPos-${i}"></div>
        </div>
        <button class="rev-btn" id="posRev-${i}" onclick="togglePosRev(${i})">D</button>
      </div>`;
    cont.appendChild(wrap);
  });
}

function syncPositionDropdowns(){
  const inputs=document.querySelectorAll('.pos-card-input');
  inputs.forEach((inp,i)=>{
    if(detectedCardsList[i]){
      inp.value=detectedCardsList[i].name;
      const btn=document.getElementById(`posRev-${i}`);
      if(btn){btn.classList.toggle('on',detectedCardsList[i].reversed);btn.textContent=detectedCardsList[i].reversed?'R':'D';}
    }
  });
}

function togglePosRev(i){
  const btn=document.getElementById(`posRev-${i}`);
  btn.classList.toggle('on');
  btn.textContent=btn.classList.contains('on')?'R':'D';
}

function showACPos(input,i){
  const val=input.value.toLowerCase().trim();
  const list=document.getElementById(`acPos-${i}`);
  if(!val){list.classList.remove('open');return;}
  const matches=ALL_CARDS.filter(c=>c.toLowerCase().includes(val)).slice(0,8);
  if(!matches.length){list.classList.remove('open');return;}
  list.innerHTML=matches.map(c=>`<div class="ac-item" onmousedown="selectACPos('${c}',${i})">${c}</div>`).join('');
  list.classList.add('open');
}
function hideACPos(i){ setTimeout(()=>document.getElementById(`acPos-${i}`).classList.remove('open'),150); }
function selectACPos(card,i){
  document.querySelector(`.pos-card-input[data-pos="${i}"]`).value=card;
  document.getElementById(`acPos-${i}`).classList.remove('open');
}
function navACPos(e,i){
  const list=document.getElementById(`acPos-${i}`);
  const items=list.querySelectorAll('.ac-item');
  let sel=list.querySelector('.sel');
  if(e.key==='ArrowDown'){e.preventDefault();if(!sel)items[0]?.classList.add('sel');else{sel.classList.remove('sel');(sel.nextElementSibling||items[0]).classList.add('sel');}}
  else if(e.key==='ArrowUp'){e.preventDefault();if(sel){sel.classList.remove('sel');(sel.previousElementSibling||items[items.length-1]).classList.add('sel');}}
  else if(e.key==='Enter'&&sel){e.preventDefault();selectACPos(sel.textContent,i);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GENERATE READING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generateReading(){
  const posInputs=document.querySelectorAll('.pos-card-input');
  const cards=[];
  posInputs.forEach((inp,i)=>{
    const card=inp.value.trim();
    const rev=document.getElementById(`posRev-${i}`)?.classList.contains('on')||false;
    cards.push({pos:chosenSpread.posizioni[i]||`Pos ${i+1}`, card:card||'(non specificata)', rev});
  });

  const styleDesc = readingStyle==='psicologica'
    ? 'psicologica e introspettiva: focalizzata sulla crescita interiore, le emozioni profonde, i pattern mentali, le risorse personali. Rifletti su stati d\'essere, blocchi inconsci e potenziale di trasformazione. Non fare previsioni sul futuro.'
    : 'cartomantica e divinatoria: ricca di simbolismo arcano, energie cosmiche, visioni del futuro. Usa un linguaggio evocativo e profetico. Parla di energie in arrivo, possibilitÃ  che si aprono, messaggi dai piani sottili.';

  const spreadText=cards.map(c=>`â€¢ ${c.pos}: ${c.card}${c.rev?' (ROVESCIATA)':''}`).join('\n');

  const prompt=`Sei un maestro cartomante con trent'anni di esperienza. Genera una lettura dei tarocchi completa.

STILE: ${styleDesc}

PROFILO DEL CLIENTE:
${clientProfile}

STESA: ${chosenSpread.nome}
${spreadText}

ISTRUZIONI:
- Lettura POSITIVA e costruttiva. Anche le carte difficili vanno lette come opportunitÃ , non come minacce.
- Caldo, empatico, personale. Il cliente si deve sentire visto.
- Apri con una visione d'insieme.
- Analizza ogni carta nella sua posizione, collegandola al profilo.
- Leggi le connessioni tra le carte.
- Chiudi con un messaggio incoraggiante e pratico.
- Almeno 600 parole. Testo fluente, non elenchi puntati.
- Scrivi in italiano, in seconda persona (tu).`;

  showScreen('screenReading');
  document.getElementById('readingOutput').innerHTML='<span class="spin"></span>  Le stelle si allineano...';

  const styleTag = readingStyle==='psicologica'?'ğŸŒ¿ Psicologica':'ğŸ”® Cartomantica';
  document.getElementById('readingMeta').innerHTML=
    `<span class="r-tag">${styleTag}</span><span class="r-tag">${chosenSpread.nome}</span><span class="r-tag">${cards.length} carte</span>`;

  try{
    const reading = await callGemini(prompt,'Sei un maestro dei tarocchi. Le tue letture sono profonde, personali e luminose. Scrivi sempre in italiano.',2500);
    document.getElementById('readingOutput').textContent=reading;
  }catch(e){
    document.getElementById('readingOutput').innerHTML=`<span style="color:var(--danger);">Errore: ${e.message}</span>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyReading(){
  navigator.clipboard.writeText(document.getElementById('readingOutput').textContent).then(()=>toast('Copiato!'));
}

function printReading(){
  const t=document.getElementById('readingOutput').textContent;
  const w=window.open('','_blank');
  w.document.write(`<html><head><title>Lettura Tarocchi</title><style>
    body{font-family:Georgia,serif;max-width:680px;margin:48px auto;line-height:2;font-size:17px;color:#1a1916;}
    h2{color:#333;letter-spacing:2px;text-align:center;margin-bottom:32px;font-size:22px;}
    pre{white-space:pre-wrap;}
  </style></head><body><h2>Lettura dei Tarocchi</h2><pre>${t}</pre></body></html>`);
  w.print();
}

function newSession(){
  clientProfile=''; suggestedSpreads=null; chosenSpread=null;
  detectedCardsList=[]; photoBase64=null;
  resetQuick();
  document.getElementById('transcriptPaste').value='';
  document.getElementById('profileDisplay').textContent='Analisi in corso...';
  document.getElementById('shortSpreads').innerHTML='';
  document.getElementById('longSpreads').innerHTML='';
  document.getElementById('detectedCards').innerHTML='';
  document.getElementById('positionRows').innerHTML='';
  document.getElementById('photoPreview').style.display='none';
  document.getElementById('photoPlaceholder').style.display='block';
  document.getElementById('btnAnalyzePhoto').disabled=true;
  switchMode('transcript');
  showScreen('screenWelcome');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARDS DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ALL_CARDS=[
  "Il Matto","Il Mago","La Papessa","L'Imperatrice","L'Imperatore","Il Papa",
  "Gli Amanti","Il Carro","La Giustizia","L'Eremita","La Ruota della Fortuna",
  "La Forza","L'Appeso","La Morte","La Temperanza","Il Diavolo","La Torre",
  "La Stella","La Luna","Il Sole","Il Giudizio","Il Mondo",
  "Asso di Coppe","2 di Coppe","3 di Coppe","4 di Coppe","5 di Coppe",
  "6 di Coppe","7 di Coppe","8 di Coppe","9 di Coppe","10 di Coppe",
  "Fante di Coppe","Cavaliere di Coppe","Regina di Coppe","Re di Coppe",
  "Asso di Denari","2 di Denari","3 di Denari","4 di Denari","5 di Denari",
  "6 di Denari","7 di Denari","8 di Denari","9 di Denari","10 di Denari",
  "Fante di Denari","Cavaliere di Denari","Regina di Denari","Re di Denari",
  "Asso di Spade","2 di Spade","3 di Spade","4 di Spade","5 di Spade",
  "6 di Spade","7 di Spade","8 di Spade","9 di Spade","10 di Spade",
  "Fante di Spade","Cavaliere di Spade","Regina di Spade","Re di Spade",
  "Asso di Bastoni","2 di Bastoni","3 di Bastoni","4 di Bastoni","5 di Bastoni",
  "6 di Bastoni","7 di Bastoni","8 di Bastoni","9 di Bastoni","10 di Bastoni",
  "Fante di Bastoni","Cavaliere di Bastoni","Regina di Bastoni","Re di Bastoni"
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2800);
}
</script>
</body>
</html>
